# koishi-plugin-tldr3

[![npm](https://img.shields.io/npm/v/koishi-plugin-tldr3?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-tldr3)

## 简介

`tldr3` 是一个 Koishi 插件，旨在帮助用户快速理解群聊中一段较长对话的核心内容。它通过调用 OpenAI API 对用户选定范围内的消息进行智能总结。`tldr3` 将群聊消息**持久化存储在数据库**中，并提供了**交互式的范围选择**功能和**自动数据清理**机制。

## 特性

*   **交互式范围选择:** 通过回复起始和结束消息来精确指定需要总结的聊天记录范围，操作直观方便。
*   **数据库持久化存储:** 将群聊消息自动存储到 Koishi 配置的数据库中（需要启用 `database` 服务），确保历史消息可供总结。

## 使用说明

1.  **启动总结任务:** 在需要总结消息的群聊中，发送命令：
    ```
    tldr3
    ```
2.  **指定总结起点:** 机器人会回复提示，要求你【回复】你希望作为**总结起点**的那条消息，并在你的回复消息中**只包含**数字 `1`。
    *   找到你想作为起点的那条消息。
    *   使用你的聊天客户端的“回复”功能，回复那条消息。
    *   在回复输入框中，只输入 `1` 并发送。
3.  **指定总结终点:** 机器人确认收到起点后，会再次提示，要求你【回复】你希望作为**总结终点**的那条消息，并在你的回复消息中**只包含**数字 `2`。
    *   找到你想作为终点的那条消息。
    *   同样使用“回复”功能，回复那条消息。
    *   在回复输入框中，只输入 `2` 并发送。
    *   *提示：选择起点和终点的顺序不重要，插件会根据消息的实际时间戳来确定范围。*
4.  **等待结果:** 机器人收到终点消息后，会提示正在获取记录并进行总结。由于需要查询数据库和调用 AI API，这可能需要一点时间。完成后，机器人会将总结结果发送到群聊中。

*   如果在交互过程中（步骤 2 或 3），你长时间没有按要求回复（超过配置的 `commandTimeout` 秒），总结任务会自动取消，机器人会发送一条通知。

## 配置项

你可以在 Koishi 的配置文件中对 `tldr3` 进行详细配置：

*   **`openaiApiKey` (string, 必填):** 用于调用 OpenAI 服务的 API 密钥。
*   **`openaiEndpoint` (string, 可选):** OpenAI API 的请求地址。如果你使用了代理或第三方兼容接口，请修改这里。
*   **`openaiModel` (string, 可选):** 指定进行总结任务的 OpenAI 模型名称。
*   **`commandTimeout` (number, 可选):** 用户从发送 `tldr3` 命令开始，到完成两次有效回复（发送 "1" 和 "2"）的总超时时间（单位：秒）。设置为 0 表示禁用超时。
*   **`Textlimit` (number, 可选):** 从数据库中提取的、准备发送给 AI 进行总结的原始消息内容总长度的最大限制（字符数）。用于防止请求体过大导致 API 调用失败或费用过高。
*   **`maxMessageAgeDays` (number, 可选):** 插件内置的定时任务会定期删除数据库中时间戳早于这个天数的消息记录。设置为 0 表示禁用自动删除（不推荐，可能导致数据库无限增长）。

## 致谢

本插件在交互设计和功能概念上受到了 [tldr](https://github.com/shakugannosaints/koishi-scripts/tree/main/tldr) 项目的启发，感谢原项目提供的宝贵思路。
